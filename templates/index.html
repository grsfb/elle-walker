<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Control</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            background-color: #f4f6f8;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #1a1a1a;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 20px auto;
        }
        button {
            padding: 20px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            width: 100%;
            height: 100%;
        }
        button:hover {
            background-color: #0056b3;
        }
        form {
            margin: 0;
            padding: 0;
        }
        #forward { grid-column: 2; grid-row: 1; }
        #left { grid-column: 1; grid-row: 2; }
        #stop { grid-column: 2; grid-row: 2; background-color: #dc3545; }
        #stop:hover { background-color: #c82333; }
        #right { grid-column: 3; grid-row: 2; }
        #backward { grid-column: 2; grid-row: 3; }
        
        .camera-controls, .results-container {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .camera-controls button {
            display: inline-block;
            width: auto;
            padding: 10px 20px;
            font-size: 1em;
        }
        #find-person-btn { background-color: #28a745; }
        #find-person-btn:hover { background-color: #218838; }

        #results-text {
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
            min-height: 25px;
        }
        #result-image-container {
            margin-top: 15px;
            min-height: 240px; /* Placeholder height */
        }
        #result-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #loading-indicator {
            display: none;
            font-size: 1em;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scout Robot Control</h1>
        
        <!-- Motor Controls -->
        <div class="control-grid">
            <button id="forward" data-action="/forward">▲</button>
            <button id="left" data-action="/left">◄</button>
            <form action="/stop" method="post"><button type="submit" id="stop">STOP</button></form>
            <button id="right" data-action="/right">►</button>
            <button id="backward" data-action="/backward">▼</button>
        </div>

        <!-- Camera Controls -->
        <div class="camera-controls">
            <h2>Camera</h2>
            <form id="find-person-form">
                <label for="person-select" style="margin-right: 10px;">Find Person:</label>
                <select name="person" id="person-select" required>
                    <option value="">--Please choose a person--</option>
                    <option value="gaurav">Gaurav</option>
                    <option value="shilpi">Shilpi</option>
                    <option value="elle">Elle</option>
                </select>
                <button type="submit" id="find-person-btn" style="margin-left: 10px;">Start Pan-and-Scan Search</button>
            </form>
            <p id="loading-indicator">Processing...</p>
        </div>

        <!-- Results Display -->
        <div class="results-container">
            <h2>Latest Recognition</h2>
            <div id="results-text">No recognition task run yet.</div>
            <div id="result-image-container">
                <img id="result-image" src="" alt="Recognition result will be shown here." style="display: none;">
            </div>
            <div id="result-video-container" style="margin-top: 15px;">
                <video id="result-video" style="max-width: 100%; border-radius: 8px; display: none;" controls autoplay muted playsinline></video>
            </div>
            <div id="summary-container" style="margin-top: 15px;">
                <h3>AI Summary:</h3>
                <p id="summary-text">...</p>
            </div>
        </div>
    </div>

        <script>

            document.addEventListener('DOMContentLoaded', function() {

                // --- Motor Control Script ---

                const motorButtons = document.querySelectorAll('.control-grid button[data-action]');

                const sendCommand = (action) => {

                    fetch(action, { method: 'POST' }).catch(error => console.error('Command Error:', error));

                };

                motorButtons.forEach(button => {

                    const action = button.dataset.action;

                    button.addEventListener('mousedown', () => sendCommand(action));

                    button.addEventListener('touchstart', (e) => { e.preventDefault(); sendCommand(action); });

                    const stopMovement = () => sendCommand('/stop');

                    button.addEventListener('mouseup', stopMovement);

                    button.addEventListener('mouseleave', stopMovement);

                    button.addEventListener('touchend', stopMovement);

                });

    

                // --- UI Elements ---

                const findPersonForm = document.getElementById('find-person-form');

                const personSelect = document.getElementById('person-select');

                const findButton = document.getElementById('find-person-btn');

                const loadingIndicator = document.getElementById('loading-indicator');

                const resultsText = document.getElementById('results-text');

                const resultImage = document.getElementById('result-image');

                const resultVideo = document.getElementById('result-video'); // Get video element

                const summaryText = document.getElementById('summary-text');

                

                let findPollingInterval;

                let summaryPollingInterval;

    

                // --- Polling Functions ---

                function pollForSummary(jobId) {

                    if (summaryPollingInterval) clearInterval(summaryPollingInterval);

                    summaryPollingInterval = setInterval(() => {

                        fetch(`/summary_status/${jobId}`)

                            .then(response => response.json())

                            .then(jobData => {

                                console.log("Summary Poll Response:", jobData);

                                if (jobData.status === 'completed' || jobData.status === 'error') {

                                    clearInterval(summaryPollingInterval);

                                    summaryText.textContent = jobData.summary;

                                } else if (jobData.status === 'processing') {

                                    summaryText.textContent = 'Summarizing...';

                                } else {

                                    clearInterval(summaryPollingInterval);

                                    summaryText.textContent = 'Could not retrieve summary.';

                                }

                            })

                            .catch(error => {

                                console.error('Summary Polling Error:', error);

                                clearInterval(summaryPollingInterval);

                                summaryText.textContent = 'Error checking summary status.';

                            });

                    }, 3000);

                }

    

                function pollForFindResult(jobId, personToFind) {

                    if (findPollingInterval) clearInterval(findPollingInterval);

                    findPollingInterval = setInterval(() => {

                        fetch(`/find_status/${jobId}`)

                            .then(response => response.json())

                            .then(jobData => {

                                console.log("Find Poll Response:", jobData);

                                let isDone = false;

                                switch (jobData.status) {

                                                                        case 'searching':

                                                                            const actionText = jobData.action ? `: ${jobData.action}` : '...';

                                                                            resultsText.textContent = `Searching for ${personToFind}${actionText}`;

                                                                            break;

                                    case 'found':

                                        isDone = true;

                                        loadingIndicator.style.display = 'none';

                                        findButton.disabled = false;

                                        resultsText.textContent = 'Found: ' + jobData.names.join(', ');

                                        

                                        // Display image

                                        if (jobData.result_image_path) {

                                            const imageUrl = `/captures/${jobData.result_image_path}?t=${new Date().getTime()}`;

                                            resultImage.src = imageUrl;

                                            resultImage.style.display = 'block';

                                        }

                                        

                                                                            // Display video

                                        

                                                                            if (jobData.result_video_path) {

                                        

                                                                                console.log("Found video path:", jobData.result_video_path); // DEBUG

                                        

                                                                                const videoUrl = `/captures/${jobData.result_video_path}?t=${new Date().getTime()}`;

                                        

                                                                                console.log("Setting video URL to:", videoUrl); // DEBUG

                                        

                                                                                resultVideo.src = videoUrl;

                                        

                                                                                resultVideo.style.display = 'block';

                                        

                                                                                console.log("Video element display style set to 'block'"); // DEBUG

                                        

                                                                            }

                                        

                                        

                                        

                                                                            // Start summary polling

                                        if (jobData.summary_job_id) {

                                            summaryText.textContent = 'Summary pending...';

                                            pollForSummary(jobData.summary_job_id);

                                        } else {

                                            summaryText.textContent = 'No summary was generated.';

                                        }

                                        break;

                                    case 'not_found_timeout':

                                        isDone = true;

                                        loadingIndicator.style.display = 'none';

                                        findButton.disabled = false;

                                        resultsText.textContent = `Could not find ${personToFind} within the time limit.`;

                                        break;

                                    case 'error':

                                        isDone = true;

                                        loadingIndicator.style.display = 'none';

                                        findButton.disabled = false;

                                        resultsText.textContent = `Error during search: ${jobData.message || 'Unknown error'}`;

                                        break;

                                }

                                if (isDone) {

                                    clearInterval(findPollingInterval);

                                }

                            })

                            .catch(error => {

                                console.error('Find Polling Error:', error);

                                clearInterval(findPollingInterval);

                                loadingIndicator.style.display = 'none';

                                findButton.disabled = false;

                                resultsText.textContent = 'A network error occurred during the search.';

                            });

                    }, 2000); // Poll every 2 seconds

                }

    

                // --- Form Submission Handler ---

                findPersonForm.addEventListener('submit', function(event) {

                    event.preventDefault();

                    

                    const personToFind = personSelect.value;

                    if (!personToFind) {

                        alert('Please select a person to find.');

                        return;

                    }

    

                    // Reset UI for a new search

                    loadingIndicator.style.display = 'block';

                    findButton.disabled = true;

                    resultsText.textContent = `Initiating search for ${personToFind}...`;

                    summaryText.textContent = '...';

                    resultImage.src = '';

                    resultImage.style.display = 'none';

                    resultVideo.src = '';

                    resultVideo.style.display = 'none';

                    if (findPollingInterval) clearInterval(findPollingInterval);

                    if (summaryPollingInterval) clearInterval(summaryPollingInterval);

    

                    // Start the find person job

                    fetch('/find_person', {

                        method: 'POST',

                        headers: { 'Content-Type': 'application/json' },

                        body: JSON.stringify({ name: personToFind }),

                    })

                    .then(response => response.json())

                    .then(data => {

                        if (data.status === 'searching' && data.job_id) {

                            // Start polling for the find result

                            pollForFindResult(data.job_id, personToFind);

                        } else {

                            // Handle initial request error

                            loadingIndicator.style.display = 'none';

                            findButton.disabled = false;

                            resultsText.textContent = 'Error starting search: ' + (data.message || 'Unknown error');

                        }

                    })

                    .catch(error => {

                        console.error('Find Person Submit Error:', error);

                        loadingIndicator.style.display = 'none';

                        findButton.disabled = false;

                        resultsText.textContent = 'A network error occurred trying to start the search.';

                    });

                });

            });

        </script>

</body>
</html>